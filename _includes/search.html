<!-- ===== FULL-SCREEN SEARCH OVERLAY ===== -->
<div id="search-overlay" aria-hidden="true" role="dialog" aria-label="Search"
     style="position:fixed;inset:0;display:none;z-index:9999;background:rgba(10,12,16,.92)">
  <div style="max-width:980px;margin:12vh auto 0;padding:0 1.25rem;color:#111">
    <div style="display:flex;align-items:center;gap:1rem;justify-content:space-between">
      <h2 style="color:#fff;margin:0;font-size:clamp(1.25rem,2vw,1.6rem);opacity:.9">
        Searching my lab notebook
      </h2>
      <button id="close-search" type="button" aria-label="Close search"
              style="background:none;border:0;color:#fff;font-size:28px;cursor:pointer;opacity:.85">×</button>
    </div>

    <div style="margin-top:1rem">
      <input id="search-input" type="text"
        placeholder="Type to search posts, tags, and content…"
        style="width:100%;background:transparent;border:0;border-bottom:2px solid rgba(255,255,255,.25);
               padding:.9rem 0;color:#fff;font-size:clamp(22px,3vw,28px);outline:none" />
    </div>

    <ul id="results-container" style="list-style:none;margin:1.5rem 0 0;padding:0;color:#e9eef5"></ul>
  </div>
</div>

<script>
(function () {
  const overlay = document.getElementById('search-overlay');
  const openBtn  = document.getElementById('open-search');
  const closeBtn = document.getElementById('close-search');
  const input    = document.getElementById('search-input');
  const results  = document.getElementById('results-container');

  function openSearch(){ overlay.style.display='block'; overlay.setAttribute('aria-hidden','false'); setTimeout(()=>input.focus(),50); }
  function closeSearch(){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); input.value=''; results.innerHTML=''; }
  window.__openSearch = openSearch;
  openBtn && openBtn.addEventListener('click', openSearch);
  closeBtn && closeBtn.addEventListener('click', closeSearch);
  overlay && overlay.addEventListener('click', e => { if (e.target===overlay) closeSearch(); });
  document.addEventListener('keydown', e => {
    if (e.key==='Escape') closeSearch();
    if (e.key==='/' && !e.metaKey && !e.ctrlKey){ e.preventDefault(); openSearch(); }
  });

  let INDEX = [];
  let ready = false;
  let lastQuery = '';
  const INDEX_URL = location.origin + '{{ "/search.json" | relative_url }}' + '?v={{ site.time | date: "%s" }}';

  function render(items){
    if (!items.length){ results.innerHTML = '<li style="opacity:.7">No results.</li>'; return; }
    results.innerHTML = items.map(it => (
      `<li style="margin:.6rem 0;padding:.4rem 0;border-bottom:1px solid rgba(255,255,255,.08)">
         <a class="sr" href="${it.url}" style="color:#fff;text-decoration:none;font-weight:600">${it.title}</a>
         <span style="opacity:.7;font-size:.9rem"> — ${it.date||''}</span>
         ${it.tags ? `<div style="opacity:.8;margin-top:.25rem;font-size:.95rem">${it.tags}</div>` : ''}
       </li>`
    )).join('');
  }

  function runSearch(q){
    const s = q.trim().toLowerCase();
    if (!s){ results.innerHTML=''; return; }
    const out = INDEX.filter(it => {
      const title = (it.title||'').toLowerCase();
      const tags  = (it.tags||'').toLowerCase();
      const cont  = (it.content||'').toLowerCase();
      return title.includes(s) || tags.includes(s) || cont.includes(s);
    }).slice(0,50);
    render(out);
  }

  results.innerHTML = '';
  fetch(INDEX_URL, { credentials:'same-origin' })
    .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
    .then(data => { INDEX = data || []; ready = true; if (lastQuery) runSearch(lastQuery); })
    .catch(err => { console.error(err); results.innerHTML = '<li style="opacity:.7">Could not load index.</li>'; });

  let t;
  input.addEventListener('input', e => {
    const val = e.target.value;
    lastQuery = val;
    clearTimeout(t);
    t = setTimeout(() => {
      if (!ready) { results.innerHTML = '<li style="opacity:.7">Loading index…</li>'; return; }
      runSearch(val);
    }, 120);
  });
})();
</script>
