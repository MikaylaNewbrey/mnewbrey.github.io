<!-- ===== FULL-SCREEN SEARCH OVERLAY ===== -->
<div id="search-overlay" aria-hidden="true" role="dialog" aria-label="Search"
     style="position:fixed;inset:0;display:none;z-index:9999;background:rgba(10,12,16,.92)">
  <div style="max-width:980px;margin:12vh auto 0;padding:0 1.25rem;color:#111">
    <div style="display:flex;align-items:center;gap:1rem;justify-content:space-between">
      <h2 style="color:#fff;margin:0;font-size:clamp(1.25rem,2vw,1.6rem);opacity:.9">
        Searching my lab notebook
      </h2>
      <button id="close-search" type="button" aria-label="Close search"
              style="background:none;border:0;color:#fff;font-size:28px;cursor:pointer;opacity:.85">×</button>
    </div>

    <div style="margin-top:1rem">
      <input id="search-input" type="text"
        placeholder="Type to search posts, tags, and content…"
        style="width:100%;background:transparent;border:0;border-bottom:2px solid rgba(255,255,255,.25);
               padding:.9rem 0;color:#fff;font-size:clamp(22px,3vw,28px);outline:none" />
    </div>

    <ul id="results-container" style="list-style:none;margin:1.5rem 0 0;padding:0;color:#e9eef5"></ul>
  </div>
</div>

<script>
(function () {
  const overlay = document.getElementById('search-overlay');
  const openBtn  = document.getElementById('open-search');
  const closeBtn = document.getElementById('close-search');
  const input    = document.getElementById('search-input');
  const results  = document.getElementById('results-container');

  function openSearch(){ overlay.style.display='block'; overlay.setAttribute('aria-hidden','false'); setTimeout(()=>input.focus(),50); }
  function closeSearch(){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); input.value=''; results.innerHTML=''; }
  window.__openSearch = openSearch;
  openBtn && openBtn.addEventListener('click', openSearch);
  closeBtn && closeBtn.addEventListener('click', closeSearch);
  overlay && overlay.addEventListener('click', e => { if (e.target===overlay) closeSearch(); });
  document.addEventListener('keydown', e => {
    if (e.key==='Escape') closeSearch();
    if (e.key==='/' && !e.metaKey && !e.ctrlKey){ e.preventDefault(); openSearch(); }
  });

  const INDEX_URL = '{{ "/search.json?v=" | append: site.time | date: "%s" | relative_url }}';
  let INDEX = [], ready = false, lastQuery = '';

  // --- helpers ---
  const esc = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  function highlight(hay, q){
    if(!q) return esc(hay);
    const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig');
    return esc(hay).replace(re,'<mark>$1</mark>');
  }
  function makeSnippet(text, q, len=160){
    const t = (text||'').trim();
    if(!q) return esc(t.slice(0,len)) + (t.length>len?'…':'');
    const i = t.toLowerCase().indexOf(q.toLowerCase());
    if(i<0) return esc(t.slice(0,len)) + (t.length>len?'…':'');
    const start = Math.max(0, i - Math.floor(len/3));
    const clip  = t.slice(start, start+len);
    return (start>0?'…':'') + highlight(clip, q) + (start+len<t.length?'…':'');
  }
  function scoreItem(it, q){
    const s = q.toLowerCase();
    let score = 0;
    if ((it.title||'').toLowerCase().includes(s)) score += 5;
    if ((it.tags||'').toLowerCase().includes(s))  score += 3;
    if ((it.content||'').toLowerCase().includes(s)) score += 1;
    return score;
  }

  function render(list, q){
  if (!q) { results.innerHTML = ''; return; }
  const count = list.length;
  const header = `<li style="list-style:none;margin:.25rem 0 .5rem;opacity:.8">${count} matching document${count===1?'':'s'}</li>`;
  const items = list.map(it => {
    if (!it || !it.url) return '';
    const safeTitle = it.title && it.title.trim() ? it.title : (it.url || 'Untitled');
    const title = highlight(safeTitle, q);
    const badge = esc(it.section || (it.kind==='post'?'Post':'Page'));
    const date  = it.date ? ` — ${esc(it.date)}` : '';
    const snip  = makeSnippet(it.content || '', q, 160);
    return `
      <li style="margin:.6rem 0;padding:.6rem 0;border-bottom:1px solid rgba(255,255,255,.08)">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem">
          <span style="font-size:.75rem;padding:.15rem .45rem;border:1px solid rgba(255,255,255,.35);border-radius:999px;opacity:.85">${badge}</span>
          <a class="sr" href="${it.url}" style="color:#fff;text-decoration:none;font-weight:700">${title}</a>
          <span style="opacity:.7;font-size:.9rem">${date}</span>
        </div>
        <div style="opacity:.85;font-size:.95rem">${snip}</div>
      </li>`;
  }).join('');
  results.innerHTML = header + items;
}
  // load index once
  fetch(INDEX_URL)
    .then(r => r.json())
    .then(data => { INDEX = data || []; ready = true; if (lastQuery) run(lastQuery); })
    .catch(() => { results.innerHTML = '<li style="opacity:.7">Could not load index.</li>'; });

  // search runner (weighted + partial)
  function run(q){
    const s = (q||'').trim();
    if (!s) { results.innerHTML=''; return; }
    const ranked = INDEX
      .map(it => ({ it, sc: scoreItem(it, s) }))
      .filter(x => x.sc > 0)
      .sort((a,b) => b.sc - a.sc)
      .slice(0,50)
      .map(x => x.it);
    render(ranked, s);
  }

  // debounce input
  let t;
  input.addEventListener('input', e => {
    lastQuery = e.target.value;
    clearTimeout(t);
    t = setTimeout(() => { if(!ready){ results.innerHTML='<li style="opacity:.7">Loading index…</li>'; return; } run(lastQuery); }, 120);
  });
})();
</script>
